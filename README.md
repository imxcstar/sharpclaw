# ğŸ¾ Sharpclaw

[ä¸­æ–‡ç‰ˆ](README_CN.md)

Sharpclaw is an advanced, highly capable **autonomous AI agent framework** built on **.NET 10**. Its core distinctiveness lies in its robust **cross-conversation long-term memory system** and **system-level operation capabilities**.

By leveraging the `Microsoft.Extensions.AI` abstraction layer, Sharpclaw seamlessly integrates with multiple LLM providers (Anthropic, OpenAI, Gemini) and interacts with users through multiple frontend channels including a Terminal UI (TUI), a Web interface, and QQ Bots.

![Main Chat Window](preview/main.png)

---

## âœ¨ Key Features

### ğŸ§  Multi-Tier Long-Term Memory System

* **Three-Layer Pipeline:** Automatically manages context through Working Memory (current session) â†’ Recent Memory (detailed summaries) â†’ Primary Memory (consolidated core facts).
* **Agentic Memory Saver:** An autonomous background agent actively decides what to save, update, or delete after each conversation turn.
* **Vector Database Integration:** Built-in vector search powered by [Sharc](https://github.com/revred/sharc.git) and SQLite, featuring semantic deduplication and a 2-stage retrieval process (Vector Search + DashScope Rerank).

### ğŸ› ï¸ System Operation Capabilities (Tools/Commands)

* **File System:** Comprehensive file operations including searching, reading, appending, editing, and directory management.
* **Process & Task Management:** Execute native OS commands, external processes, HTTP requests, and manage background tasks. Tasks support foreground (blocking) and background modes, with full lifecycle management including output streaming (stdout/stderr/combined), stdin writing, keyword/regex-based output waiting, and process tree termination. All background tasks are automatically killed and cleaned up on application exit.

### ğŸ“± Multi-Channel Support

* **TUI (Terminal.Gui):** A feature-rich terminal interface with collapsible logs, slash-command auto-completion, and configuration dialogs.
* **Web (WebSocket):** A lightweight ASP.NET Core web server with a modern UI (Tokyo Night theme) and real-time streaming.
* **QQ Bot:** Native integration with QQ channels, groups, and private messages.

### ğŸ”’ Secure Configuration

* Cross-platform secure credential storage (Windows Credential Manager, macOS Keychain, Linux libsecret) using AES-256-CBC encryption for API keys.
* Automatic configuration version migration (up to v8).
* Per-provider custom request body injection (e.g. `"thinking"`, `"reasoning_split"`) â€” configurable globally or per-agent via the Config Dialog.

---

## ğŸš€ Getting Started

### Prerequisites

* [.NET 10.0 SDK (Preview)](https://dotnet.microsoft.com/)
* Git (for cloning submodules)

### Build and Run

1. Clone the repository with its submodules:
```bash
git clone --recursive https://github.com/yourusername/sharpclaw.git
cd sharpclaw
```

2. Build the entire solution:
```bash
dotnet build
```

3. Run the application via the CLI. Sharpclaw routes the startup based on the command provided:

* **Start Terminal UI (Default):**
```bash
dotnet run --project sharpclaw tui
```
First run automatically launches the configuration wizard:

![Config Dialog](preview/config.png)

* **Start Web Server:**
```bash
dotnet run --project sharpclaw web
```

![Web Chat Interface](preview/web.png)

* **Start QQ Bot:**
```bash
dotnet run --project sharpclaw qqbot
```

* **Open Configuration UI:**
```bash
dotnet run --project sharpclaw config
```

---

## ğŸ—ï¸ Architecture

### System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend Layer (Channels/)                                  â”‚
â”‚  â”œâ”€â”€ Tui/ â€” Terminal.Gui v2 (ChatWindow, ConfigDialog)      â”‚
â”‚  â”œâ”€â”€ Web/ â€” ASP.NET Core WebSocket server                   â”‚
â”‚  â””â”€â”€ QQBot/ â€” QQ Bot integration (Luolan.QQBot)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Agent Layer (Agents/)                                       â”‚
â”‚  â”œâ”€â”€ MainAgent â€” Conversation loop, tool orchestration      â”‚
â”‚  â”œâ”€â”€ MemorySaver â€” Autonomous memory management             â”‚
â”‚  â””â”€â”€ ConversationArchiver â€” Two-phase memory consolidation  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Memory Pipeline (Chat/, Memory/)                            â”‚
â”‚  â”œâ”€â”€ MemoryPipelineChatReducer â€” Context window management  â”‚
â”‚  â”œâ”€â”€ VectorMemoryStore â€” Sharc + SQLite vector search       â”‚
â”‚  â””â”€â”€ InMemoryMemoryStore â€” Keyword-based fallback           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Command System (Commands/)                                  â”‚
â”‚  â”œâ”€â”€ FileCommands â€” File operations (cat, edit, find, etc.) â”‚
â”‚  â”œâ”€â”€ ProcessCommands â€” Bash/PowerShell execution            â”‚
â”‚  â”œâ”€â”€ HttpCommands â€” HTTP requests                           â”‚
â”‚  â”œâ”€â”€ TaskCommands â€” Background task management              â”‚
â”‚  â””â”€â”€ SystemCommands â€” System info, exit                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Core Infrastructure (Core/)                                 â”‚
â”‚  â”œâ”€â”€ AgentBootstrap â€” Shared initialization                 â”‚
â”‚  â”œâ”€â”€ SharpclawConfig â€” Configuration with encryption        â”‚
â”‚  â”œâ”€â”€ ClientFactory â€” LLM client creation                    â”‚
â”‚  â”œâ”€â”€ DataProtector/KeyStore â€” AES-256-CBC encryption        â”‚
â”‚  â””â”€â”€ TaskManager â€” Background process management            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Memory System

Sharpclaw implements a sophisticated three-layer memory pipeline:

| Layer | File | Purpose |
|-------|------|---------|
| **Working Memory** | `working_memory.md` | Current conversation snapshot |
| **Recent Memory** | `recent_memory.md` | Detailed summaries (append-only) |
| **Primary Memory** | `primary_memory.md` | Consolidated core facts |
| **Vector Store** | `memories.db` | Semantic embeddings + metadata |
| **History** | `history/*.md` | Archived full conversations |

**Pipeline Flow:**
1. After each turn â†’ MemorySaver analyzes and updates vector store
2. When context window overflows â†’ Summarizer generates detailed summary â†’ appends to recent memory
3. When recent memory > 30k chars â†’ Consolidator extracts core info â†’ overwrites primary memory

### IChatIO Abstraction

The AI engine is decoupled from frontend through `IChatIO` interface:
- **TUI:** `Channels/Tui/ChatWindow.cs` â€” Terminal.Gui v2 interface
- **Web:** `Channels/Web/WebSocketChatIO.cs` â€” WebSocket frontend
- **QQ Bot:** `Channels/QQBot/QQBotServer.cs` â€” QQ Bot interface

All frontends share the same `MainAgent` logic.

---

## ğŸ“ Project Structure

```
sharpclaw/
â”œâ”€â”€ sharpclaw/                   â† Main project
â”‚   â”œâ”€â”€ Program.cs               â† Entry point (tui/web/qqbot/config)
â”‚   â”œâ”€â”€ sharpclaw.csproj         â† Project file (net10.0)
â”‚   â”œâ”€â”€ Abstractions/            â† IChatIO, IAppLogger interfaces
â”‚   â”œâ”€â”€ Agents/                  â† MainAgent, MemorySaver, ConversationArchiver
â”‚   â”œâ”€â”€ Channels/                â† Tui, Web, QQBot frontends
â”‚   â”œâ”€â”€ Chat/                    â† MemoryPipelineChatReducer
â”‚   â”œâ”€â”€ Clients/                 â† DashScopeRerankClient, ExtraFieldsPolicy
â”‚   â”œâ”€â”€ Commands/                â† All tool implementations
â”‚   â”œâ”€â”€ Core/                    â† Config, Bootstrap, TaskManager
â”‚   â”œâ”€â”€ Memory/                  â† IMemoryStore, VectorMemoryStore
â”‚   â”œâ”€â”€ UI/                      â† ConfigDialog, AppLogger
â”‚   â””â”€â”€ wwwroot/                 â† Web UI (index.html)
â”œâ”€â”€ preview/                     â† Screenshots
â”œâ”€â”€ sharc/                       â† Submodule: high-performance SQLite library
â”‚   â”œâ”€â”€ src/                     â† 9 project folders (Sharc, Sharc.Vector, etc.)
â”‚   â”œâ”€â”€ tests/                   â† 11 test projects (3,467 tests)
â”‚   â”œâ”€â”€ bench/                   â† BenchmarkDotNet suites
â”‚   â””â”€â”€ docs/                    â† Architecture & feature docs
â”œâ”€â”€ CLAUDE.md                    â† AI assistant instructions
â”œâ”€â”€ README.md / README_CN.md     â† Documentation
â””â”€â”€ sharpclaw.slnx               â† Solution file
```

---

## ğŸ”§ Configuration

Configuration is stored in `~/.sharpclaw/config.json` (version 8):

```json
{
  "version": 8,
  "default": {
    "provider": "anthropic",
    "apiKey": "...",
    "model": "claude-3-5-sonnet-20241022"
  },
  "agents": {
    "main": { "enabled": true },
    "saver": { "enabled": true },
    "summarizer": { "enabled": true }
  },
  "memory": {
    "embeddingProvider": "openai",
    "embeddingModel": "text-embedding-3-small"
  },
  "channels": {
    "web": { "address": "127.0.0.1", "port": 5000 }
  }
}
```

- **API keys** encrypted at rest with AES-256-CBC
- **Encryption key** stored in OS credential manager
- **Per-agent overrides** can specify different provider/model
- **ExtraRequestBody** supports custom fields (e.g., `thinking`)

---

## ğŸ§© Sharc Submodule

Sharpclaw includes [Sharc](https://github.com/revred/sharc.git) as a submodule â€” a high-performance, pure managed C# library for reading/writing SQLite files:

- **Pure managed C#** â€” zero native dependencies
- **609x faster** B-tree seeks than Microsoft.Data.Sqlite
- **Zero allocation** per-row reads via `Span<T>`
- **Built-in features:** Encryption, Graph queries (Cypher), Vector search, SQL pipeline

See `sharc/README.md` and `sharc/CLAUDE.md` for details.

---

## ğŸ“ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

Copyright (c) 2025 sharpclaw.
